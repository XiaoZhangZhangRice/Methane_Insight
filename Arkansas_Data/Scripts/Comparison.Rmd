---
title: "Comparison"
author: "Zhang Zhenglin"
output:
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: sentence
---

# Brief overview

There are two base data files. Here we define slope as the change in concentration over time (ΔC/ΔT).
We compare here, the slopes between the MI sensor and the Li-Cor 7810. The slopes from each of the instruments
are recorded in a single file. 

The main aim of the this script is to 
1) Combine these two datasets into a data frame via unique matching using a set of variables such that the measurements from the same chamber are part of one observation or row. 
2) Perform basic statistical analyses to evaluate if the measurements obtained are comparable

# Necessary libraries

```{r message=FALSE,warning=FALSE}
library(knitr)
library(ggplot2)
theme_set(theme_bw())
library(emmeans)
library(multcomp)
library(PLS205)
library(lme4)
library(lmerTest)
library(multcompView)
library(car)
library(Rmisc) 
library(dplyr) #https://r4ds.had.co.nz/ (Chapter 3, Chapter 5, look at filter and select)
# https://bookdown.org/ansellbr/WEHI_tidyR_course_book/
library(stringr) 
library(data.table)
library(GGally)
library(formatR)
library(readxl)
library(FluxCalR)
library(tidyverse)
library(fuzzyjoin)
library(purrr)
library(data.table)
library(broom)
library(lubridate)
library(readxl)
library(openxlsx)
library(ggrepel)
library(gridExtra)
library(ggpubr)
library(cluster)
```

# Read excel and clean dataframe from MI

All slopes here were manually extracted. Where the researchers were unsure if the slope matched a particular observation, 
or if the sensor appeared to not be recording good data, the data point was saved as "na" (variable class: chr). 

Before removing "na", we have a total of 557 observations. After removing "na" we are left with 416 observations.

```{r}
MI_slopes <- read_excel("../Data/All_MI_measurements_FILLED_27Jan.xlsx", sheet=1)

sum(MI_slopes$MI_slope  == "na", na.rm = TRUE)

557-sum(MI_slopes$MI_slope  == "na", na.rm = TRUE) # number of observations left

MI_slopes <- MI_slopes %>%
  filter(tolower(MI_slope) != "na") %>% #remove datapoints that we are not confident of 
  select(-6) # this col is not need (used for basic inter rater reliabilty test)
  

MI_slopes <- MI_slopes %>%
  mutate(
    MI_slope = as.numeric(MI_slope),
    across(where(is.character), as.factor)
  ) #%>%
    #filter(MI_slope <15)


str(MI_slopes)
```


# Read excel and clean dataframe from Li-Cor

All slopes automatically computed. The vast majority of measurements were 3 mins long. The first 30s was removed as a deadband. 

Afterwards, the rest of the points were used to calculate slopes. 

Here, we do a quality control step. We removed observations with R2 values lower than 0.85. 

```{r}
LiCor_slopes <- read_excel("../Data/ch4_slopes_licor_2024-2025.xlsx", sheet=1)

LiCor_slopes <- LiCor_slopes %>%
  filter(r2 > 0.9) %>%
  mutate(across(where(is.character), as.factor))# %>%
 # filter(slope_ppm_per_h >10) %>%
 # filter(slope_ppm_per_h <75)




str(LiCor_slopes)
```
# Combine the two dataframes via unique matching

```{r}

Combined <- MI_slopes %>%
  left_join(
    LiCor_slopes %>%
      select(Field, Collar, Replicate, DATE,
             slope_ppm_per_h, n_points, r2),
    by = c("Field", "Collar", "Replicate", "DATE")
  ) %>%
  mutate(LiCor_slope =slope_ppm_per_h)

Combined <- na.omit(Combined)


Combined <- Combined %>%
dplyr::mutate(Year = factor(format(DATE, "%Y"))) %>%
dplyr::mutate(Month_Year = factor(format(DATE, "%b %Y")))

str(Combined)
```



# Initial visualisation

```{r}

Combined_everything <-
  ggplot(data=Combined, aes(x=MI_slope, y=LiCor_slope))+
  geom_point()+
  #aes(color=Year)+
  geom_abline(intercept = 0, slope = 1)+
  scale_x_continuous(limits = c(-50, 50), expand = c(0, 0))+
  scale_y_continuous(limits = c(-20, 150), expand = c(0, 0))+
  stat_regline_equation(aes(x=MI_slope, y=LiCor_slope, 
    label =  paste(..rr.label..)),
    show.legend = FALSE, 
    label.x = 20,
    label.y = 20)+
  stat_regline_equation(aes(x=MI_slope, y=LiCor_slope, 
    label = paste(..eq.label..)),
    show.legend = FALSE, 
    label.x = 20, 
    label.y = 25)+
   ggtitle("(a) All observations")+
   labs(y = expression("ΔC"[Li-Cor] * "(ppm hr"^-1 * ")"),
       x = expression("ΔC"[MLCS] * "(ppm hr"^-1 * ")")) +
  geom_smooth(data=Combined, aes(x=MI_slope, y=LiCor_slope),method="lm", level = 0.95)

Combined_everything
```


# Initial visualisation (by year)

```{r}
ggplot(data=Combined, aes(x=MI_slope, y=LiCor_slope))+
  geom_point()+
  aes(color=Year)+
  geom_abline(intercept = 0, slope = 1)+
  scale_x_continuous(limits = c(-50, 50), expand = c(0, 0))+
  scale_y_continuous(limits = c(-20, 150), expand = c(0, 0))+
  
   #ggtitle("Linear regression")+
   labs(y = expression("ΔC"[Li-Cor] * "(ppm hr"^-1 * ")"),
       x = expression("ΔC"[MLCS] * "(ppm hr"^-1 * ")")) 
  #geom_smooth(data=Combined, aes(x=MI_slope, y=LiCor_slope),method="lm", level = 0.95)
```

# Initial visualisation (by month_year)

```{r}
Month_Year_Plot <-
  ggplot(data=Combined, aes(x=MI_slope, y=LiCor_slope))+
  geom_point()+
  aes(color=Month_Year)+
  geom_abline(intercept = 0, slope = 1)+
  #scale_x_continuous(limits = c(-10, 50), expand = c(0, 0))+
  #scale_y_continuous(limits = c(-1, 149), expand = c(0, 0))+
  
   ggtitle("(b) All observations by Month_Year")+
   labs(y = expression("ΔC"[Li-Cor] * "(ppm hr"^-1 * ")"),
       x = expression("ΔC"[MLCS] * "(ppm hr"^-1 * ")")) 
  #geom_smooth(data=Combined, aes(x=MI_slope, y=LiCor_slope),method="lm", level = 0.95)

Month_Year_Plot
```

```{r}
cor.test(Combined$MI_slope,Combined$LiCor_slope, method = "pearson")
```

# Initial visualisation (remove low fluxes and high fluxes)

```{r}
Combined_middle_ground <-  Combined %>%
  filter(slope_ppm_per_h >10) %>%
  filter(slope_ppm_per_h <75) %>%
  filter(MI_slope <12)
```


```{r}
ggplot(data=Combined_middle_ground, aes(x=MI_slope, y=LiCor_slope))+
  geom_point()+
  #aes(color=Year)+
  geom_abline(intercept = 0, slope = 1)+
  scale_x_continuous(limits = c(-50, 50), expand = c(0, 0))+
  scale_y_continuous(limits = c(-20, 150), expand = c(0, 0))+
  stat_regline_equation(aes(x=MI_slope, y=LiCor_slope, 
    label =  paste(..rr.label..)),
    show.legend = FALSE, 
    label.x = 20,
    label.y = 20)+
  stat_regline_equation(aes(x=MI_slope, y=LiCor_slope, 
    label = paste(..eq.label..)),
    show.legend = FALSE, 
    label.x = 20, 
    label.y = 25)+
   #ggtitle("Linear regression")+
   labs(y = expression("ΔC"[Li-Cor] * "(ppm hr"^-1 * ")"),
       x = expression("ΔC"[MLCS] * "(ppm hr"^-1 * ")")) +
  geom_smooth(data=Combined_middle_ground, aes(x=MI_slope, y=LiCor_slope),method="lm", level = 0.95)
```



# K meansClustering 

```{r}

ss<-sapply(1:10, function(k){
out<-kmeans(scale(Combined[,c(5,9)]), centers=k, nstart=25)
out$tot.withinss
})

plot(1:10, ss, type="b")

silhouette_score <- sapply(2:10, function(k){
km <- kmeans(scale(Combined[,c(5,9)]), centers=k, nstart=25)
sil <- silhouette(km$cluster, dist(scale(Combined[,c(5,9)])))
mean(sil[, 3])
})

plot(2:10, silhouette_score, type='b' )


k_clusts<-kmeans(scale(Combined[,c(5,9)]), centers=5, nstart = 100)
Combined$k_clusts_3<-factor(k_clusts$cluster)

Cluster <- 
ggplot(Combined, aes(x=MI_slope, y=LiCor_slope))+
geom_point(aes(col=k_clusts_3), size=2)+
  ggtitle("(c) K-Means clustering (5 clusters)")

Cluster

```
# Look only at Rep 2 due to longer retention time

```{r}
Combined_Rep2 <- Combined %>% filter(Replicate == "Rep2") 

Rep2 <- 
  ggplot(data=Combined_Rep2, aes(x=MI_slope, y=LiCor_slope))+
  geom_point()+
  #aes(color=Month_Year)+
  geom_abline(intercept = 0, slope = 1)+
  scale_x_continuous(limits = c(-50, 50), expand = c(0, 0))+
  scale_y_continuous(limits = c(-20, 150), expand = c(0, 0))+
  stat_regline_equation(aes(x=MI_slope, y=LiCor_slope, 
    label =  paste(..rr.label..)),
    show.legend = FALSE, 
    label.x = 20,
    label.y = 20)+
  stat_regline_equation(aes(x=MI_slope, y=LiCor_slope, 
    label = paste(..eq.label..)),
    show.legend = FALSE, 
    label.x = 20, 
    label.y = 25)+
   ggtitle("(d) Rep 2 only")+
   labs(y = expression("ΔC"[Li-Cor] * "(ppm hr"^-1 * ")"),
       x = expression("ΔC"[MLCS] * "(ppm hr"^-1 * ")")) 
 # geom_smooth(data=Combined_Rep2, aes(x=MI_slope, y=LiCor_slope),method="lm", level = 0.95)

Rep2
```


# Combine all necessary graphs



```{r}
Combined_ALL <- ggarrange(Combined_everything,
                          Month_Year_Plot,
                    Cluster,
                    Rep2,
                    nrow = 2,
                               ncol = 2
                               )

ggsave(filename = "Combined_ALL.jpg",  # Include the file extension here
       plot = Combined_ALL,              # Specify the plot
       path = "../Figures",
       dpi = 400,
       height = 40, width = 40, units = "cm")

```


# Difference across time

```{r}
Combined$Difference <- Combined$LiCor_slope-Combined$MI_slope

diff_over_time <- 
  ggplot(Combined, aes(x=DATE, y=Difference))+
  aes(color=Month_Year)+
  geom_point()+
  geom_boxplot()
  

Combined_graphing <- Combined %>%
  group_by(DATE) %>%
  mutate(Difference_sd = sd(Difference)) %>%
  summarise(Difference = mean(Difference),
  Difference_sd = mean(Difference_sd))

diff_over_time_1 <- 
  ggplot(Combined_graphing, aes(x=DATE, y=Difference))+
  geom_point(size = 3)+
  geom_point(data = Combined, , size=1, alpha=0.4)+
  scale_x_datetime(name = "",
    limits = as.POSIXct(c("2024-07-15", "2024-09-30")), # Set x-axis limits
    date_labels = "%b %Y",
    date_breaks = "1 month")+
  scale_y_continuous(limits = c(-50, 150), expand = c(0, 0), breaks = seq(-50,150, by=25))+
  geom_errorbar(data=Combined_graphing, aes(ymin=Difference-Difference_sd, ymax=Difference+Difference_sd), width=8, size =0.5, color = "red")

diff_over_time_2 <- 
  ggplot(Combined_graphing, aes(x=DATE, y=Difference))+
  geom_point(size = 3)+
  geom_point(data = Combined, , size=1, alpha=0.4)+
  scale_x_datetime(name = "",
    limits = as.POSIXct(c("2025-04-15", "2025-05-30")), # Set x-axis limits
    date_labels = "%b %Y",
    date_breaks = "1 month")+
  scale_y_continuous(limits = c(-50, 150), expand = c(0, 0), breaks = seq(-50,150, by=25))+
  geom_errorbar(data=Combined_graphing, aes(ymin=Difference-Difference_sd, ymax=Difference+Difference_sd), width=8, size =0.5, color = "red")


Diffs <- ggarrange(diff_over_time_1,
                    diff_over_time_2,
                    nrow = 1,
                               ncol = 2,
                               common.legend = TRUE,
                               #legend.grob = get_legend(N_response_curve_average),
                               legend= "bottom")
Diffs

ggsave(filename = "diff_over_time.jpg",  # Include the file extension here
       plot = Diffs,              # Specify the plot
       path = "../Figures",
       dpi = 400,
       height = 20, width = 40, units = "cm")

```
# Look at covariates, read sensor data into dataframe

```{r}
field <- read_csv(
  "../Data/MI_Full_datalog.csv",
  skip = 3,
  #col_types = rep("guess", 13)
)

field <- field %>%
  dplyr::mutate(Date = as.POSIXct(
    datetime,
    format = "%Y/%m/%d %H:%M:%S",
    tz = "UTC"
  ))

str(field)


field <- field %>% select(Date, RH, tempC) %>% mutate(RH = as.numeric(RH), tempC = as.numeric(tempC)) %>%
        mutate(RH_mean = RH, tempC_mean = tempC)


daily_avg <- field %>%
  mutate(Date = as.Date(Date)) %>%   # in case Date has time
  group_by(Date) %>%
  summarise(
    RH_mean    = mean(RH),
    tempC_mean = mean(tempC)
  ) %>%
  mutate(Date = as.POSIXct(Date))

```
# Look at Temp 

```{r}
Temp <- 
ggplot(daily_avg, aes(x=Date, y=tempC_mean))+
  geom_point(size = 3)+
  geom_point(data = field, size =0.1)+
    scale_x_datetime(name = "",
    date_labels = "%b %Y",
    date_breaks = "1 month")

Temp

ggsave(filename = "Temp_over_time.jpg",  # Include the file extension here
       plot = Temp,              # Specify the plot
       path = "../Figures",
       dpi = 400,
       height = 20, width = 40, units = "cm")
```


# Look at RH

```{r}
RH <- 
    ggplot(daily_avg, aes(x=Date, y=RH_mean))+
  geom_point(size = 3)+
  geom_point(data = field, size=0.1)+
    scale_x_datetime(name = "",
    date_labels = "%b %Y",
    date_breaks = "1 month")+
  scale_y_continuous(limits = c(0, 150), expand = c(0, 0))

RH

ggsave(filename = "RH_over_time.jpg",  # Include the file extension here
       plot = RH,              # Specify the plot
       path = "../Figures",
       dpi = 400,
       height = 20, width = 40, units = "cm")
```
# Combine RH and TempC

```{r}
RH_Temp <- ggarrange(RH,
                    Temp,
                    nrow = 1,
                               ncol = 2
                               )

ggsave(filename = "RH_Temp.jpg",  # Include the file extension here
       plot = RH_Temp,              # Specify the plot
       path = "../Figures",
       dpi = 400,
       height = 20, width = 40, units = "cm")
```

